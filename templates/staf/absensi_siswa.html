{% extends "base.html" %}
{% block title %}Daftar Absensi Siswa{% endblock %}
{% block content %}

<style>
  #tbodyAbsensi {
    transition: opacity 0.3s ease-in-out;
  }
  #tbodyAbsensi.loading {
    opacity: 0.5;
  }
</style>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>ğŸ“‹ Daftar Absensi Siswa</h4>
    <a href="{{ url_for('staf.absen_manual') }}" class="btn btn-success btn-sm">â• Tambah Manual</a>
  </div>

  <!-- FILTER -->
  <form id="filterAbsensi" class="row g-2 mb-3">
    <div class="col-md-3">
      <input type="date" name="tgl_awal" class="form-control" value="{{ tgl_awal }}">
    </div>
    <div class="col-md-3">
      <input type="date" name="tgl_akhir" class="form-control" value="{{ tgl_akhir }}">
    </div>
    <div class="col-md-3">
      <select name="kelas" class="form-select">
        <option value="">Semua Kelas</option>
        {% for k in semua_kelas %}
          <option value="{{ k }}" {% if kelas == k %}selected{% endif %}>{{ k }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <input type="text" name="cari" class="form-control" placeholder="Cari nama siswa...">
    </div>
  </form>

<div class="text-end mb-3">
  <button id="btnExcel" class="btn btn-sm btn-success">ğŸ“Š Ekspor Excel</button>
  <button id="btnPDF" class="btn btn-sm btn-danger">ğŸ“„ Ekspor PDF</button>
</div>

  <!-- TABEL -->
  <table class="table table-hover table-bordered shadow-sm align-middle">
    <thead class="table-primary text-center">
      <tr>
        <th>Tanggal</th>
        <th>NIS</th>
        <th>Nama</th>
        <th>Kelas</th>
        <th>Status</th>
        <th>Keterangan</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody id="tbodyAbsensi">
      <tr id="loadingRow" style="display: none;">
        <td colspan="7" class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <div class="mt-2 text-muted small">Memuat data...</div>
        </td>
      </tr>

      {% for a in data %}
      <tr>
        <td>{{ a.tanggal }}</td>
        <td>{{ a.nis }}</td>
        <td>{{ a.nama }}</td>
        <td>{{ a.kelas }}</td>
        <td>{{ a.status }}</td>
        <td>{{ a.keterangan or '-' }}</td>
        <td class="text-center">
          <a href="{{ url_for('staf.edit_absensi', id=a.id) }}" class="btn btn-warning btn-sm">âœï¸ Edit</a>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="7" class="text-center text-muted">Tidak ada data absensi</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div id="paginationContainer" class="mt-3 text-center"></div>


<!-- SCRIPT AJAX FILTER -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const form = document.getElementById("filterAbsensi");
  const tbody = document.getElementById("tbodyAbsensi");
  const loadingRow = document.getElementById("loadingRow");

  function kirimFilter() {
    const formData = new FormData(form);
    tbody.classList.add("loading");
    if (loadingRow) loadingRow.style.display = "";

    fetch("{{ url_for('staf.filter_absensi_siswa') }}", {
      method: "POST",
      body: formData
    })
    .then(res => res.text())
    .then(html => {
      tbody.innerHTML = html;
      // Tambahkan kembali spinner (agar tidak hilang untuk request berikut)
      tbody.insertAdjacentHTML("afterbegin", `
        <tr id="loadingRow" style="display:none;">
          <td colspan="7" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2 text-muted small">Memuat data...</div>
          </td>
        </tr>
      `);
    })
    .finally(() => {
      tbody.classList.remove("loading");
      const spinner = document.getElementById("loadingRow");
      if (spinner) spinner.style.display = "none";
    });
  }

  // Jalankan filter otomatis
  form.querySelectorAll("input, select").forEach(el => {
    el.addEventListener("input", kirimFilter);
    el.addEventListener("change", kirimFilter);
  });

  // Prevent reload saat tekan Enter
  form.addEventListener("submit", function(e) {
    e.preventDefault();
    kirimFilter();
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const form = document.getElementById("filterAbsensi");
  const tbody = document.getElementById("tbodyAbsensi");
  const paginationContainer = document.getElementById("paginationContainer");
  const loadingRow = document.getElementById("loadingRow");

  let halamanAktif = 1;

  function kirimFilter() {
    const formData = new FormData(form);
    formData.append("page", halamanAktif);

    tbody.classList.add("loading");
    if (loadingRow) loadingRow.style.display = "";

    fetch("{{ url_for('staf.pagination_absensi_siswa') }}", {
      method: "POST",
      body: formData
    })
    .then(res => res.text())
    .then(html => {
      tbody.innerHTML = html;
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      const divPagination = doc.querySelector("div.d-flex");
      paginationContainer.innerHTML = divPagination ? divPagination.outerHTML : "";
      tbody.insertAdjacentHTML("afterbegin", document.getElementById("loadingRow").outerHTML);
    })
    .finally(() => {
      tbody.classList.remove("loading");
      const spinner = document.getElementById("loadingRow");
      if (spinner) spinner.style.display = "none";
    });
  }

  // pagination
  window.gantiHalaman = function(page) {
    halamanAktif = page;
    kirimFilter();
  };

  form.addEventListener("submit", e => { e.preventDefault(); halamanAktif = 1; kirimFilter(); });
  form.querySelectorAll("input, select").forEach(el => {
    el.addEventListener("input", () => { halamanAktif = 1; kirimFilter(); });
    el.addEventListener("change", () => { halamanAktif = 1; kirimFilter(); });
  });

  // ekspor Excel dan PDF
  document.getElementById("btnExcel").addEventListener("click", () => {
    const params = new URLSearchParams(new FormData(form)).toString();
    window.open(`/staf/absensi_siswa/ekspor_excel?${params}`, "_blank");
  });
  document.getElementById("btnPDF").addEventListener("click", () => {
    const params = new URLSearchParams(new FormData(form)).toString();
    window.open(`/staf/absensi_siswa/ekspor_pdf?${params}`, "_blank");
  });

  kirimFilter(); // Load awal
});
</script>

{% endblock %}

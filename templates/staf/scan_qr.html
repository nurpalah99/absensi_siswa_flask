{% extends "staf/base_staf.html" %}
{% block title %}Scan QR | Sistem Absensi{% endblock %}
{% block header %}Pemindaian QR Siswa{% endblock %}

{% block content %}
<div class="container text-center mt-4">
  <h5 class="mb-3">ðŸ“· Arahkan kamera ke QR Code siswa</h5>
  <div id="reader" style="width:320px;margin:auto;border:4px solid #0d6efd;border-radius:12px;"></div>
  <div id="scan-status" class="mt-3 text-secondary small">Menunggu hasil scan...</div>
</div>

<audio id="sound-beep" src="{{ url_for('static', filename='sound/beep.mp3') }}"></audio>
<audio id="sound-warning" src="{{ url_for('static', filename='sound/warning.mp3') }}"></audio>
<audio id="sound-error" src="{{ url_for('static', filename='sound/error.mp3') }}"></audio>

<script src="{{ url_for('static', filename='js/html5-qrcode.min.js') }}"></script>
<script>
const statusBox = document.getElementById("scan-status");
const beep = document.getElementById("sound-beep");
const warn = document.getElementById("sound-warning");
const errS = document.getElementById("sound-error");

let currentCamera = "environment";
let scanner = null;
let isProcessing = false;

function playSound(t){ try{
  if(t==="ok") beep.play(); else if(t==="warn") warn.play(); else errS.play();
}catch{}}

function showStatus(txt,cls="text-secondary"){statusBox.className=cls;statusBox.textContent=txt;}

async function startScanner(){
  try{
    if(scanner){ try{ await scanner.stop(); await scanner.clear(); }catch{} }
    scanner = new Html5Qrcode("reader");
    const devices = await Html5Qrcode.getCameras();
    if(!devices.length){ showStatus("Kamera tidak ditemukan!","text-danger"); return;}
    const camId = currentCamera==="front"&&devices.length>1 ? devices[0].id : devices[devices.length-1].id;
    await scanner.start(camId,{fps:10,qrbox:250},onScanSuccess);
    showStatus("ðŸ“¡ Kamera aktif, arahkan ke QR siswa","text-success");
  }catch(e){
    console.error(e);
    showStatus("âš ï¸ Tidak bisa mengakses kamera","text-danger");
  }
}

async function onScanSuccess(decodedText){
  if(isProcessing) return;
  isProcessing = true;
  showStatus("â³ Memproses data...","text-primary");
  try{
    if(scanner){ try{ await scanner.stop(); await scanner.clear(); }catch{} }
    const res = await fetch("/api/absen_qr",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({qr:decodedText})
    });
    const data = await res.json();
    if(data.success){
      playSound("ok");
      showStatus("âœ… "+data.message,"text-success");
    }else{
      playSound("warn");
      showStatus("âš ï¸ "+(data.message||"Gagal memproses"),"text-warning");
    }
  }catch(e){
    console.error(e);
    playSound("err");
    showStatus("âŒ Koneksi gagal","text-danger");
  }finally{
    // tunggu 1.5 detik lalu restart kamera
    setTimeout(()=>{
      isProcessing=false;
      startScanner();
    },1500);
  }
}

document.addEventListener("DOMContentLoaded",startScanner);
</script>
{% endblock %}

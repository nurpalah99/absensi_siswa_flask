{% extends "admin/base_admin.html" %}
{% block title %}Laporan Absensi{% endblock %}
{% block content %}
<div class="container mt-4">
  <h3>üìä Laporan Absensi Siswa</h3>

  <!-- Form Filter -->
  <form method="POST" class="row g-3 my-3">
    <div class="col-md-3">
      <label class="form-label">Dari</label>
      <input type="date" name="tgl_awal" class="form-control" value="{{ tgl_awal }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Sampai</label>
      <input type="date" name="tgl_akhir" class="form-control" value="{{ tgl_akhir }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Kelas</label>
      <select name="kelas" class="form-select">
        <option value="">Semua Kelas</option>
        {% for k in semua_kelas %}
        <option value="{{ k }}" {% if kelas == k %}selected{% endif %}>{{ k }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Siswa</label>
      <select name="nis" class="form-select">
        <option value="">Semua Siswa</option>
        {% for s in semua_siswa %}
        <option value="{{ s.nis }}" {% if nis == s.nis %}selected{% endif %}>{{ s.nama }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-12 text-end">
      <button class="btn btn-primary">üîç Tampilkan</button>
    </div>
  </form>

  <hr>

  <!-- Statistik Ringkas -->
  <div class="row text-center">
    <div class="col"><strong>Hadir:</strong> {{ total_hadir }}</div>
    <div class="col"><strong>Terlambat:</strong> {{ total_terlambat }}</div>
    <div class="col"><strong>Sakit:</strong> {{ total_sakit }}</div>
    <div class="col"><strong>Izin:</strong> {{ total_izin }}</div>
    <div class="col"><strong>Bolos:</strong> {{ total_bolos }}</div>
    <div class="col text-success"><strong>Kehadiran:</strong> {{ persen_hadir }}%</div>
  </div>

  <!-- Grafik -->
  <canvas id="grafik" height="100" class="mt-4"></canvas>

  <!-- Tabel Data -->
  <table class="table table-striped table-bordered mt-4">
    <thead class="table-dark">
      <tr>
        <th>Tanggal</th>
        <th>NIS</th>
        <th>Nama</th>
        <th>Kelas</th>
        <th>Jenis Absen</th>
        <th>Status</th>
        <th>Waktu</th>
      </tr>
    </thead>
    <tbody>
      {% for d in data %}
      <tr>
        <td>{{ d.tanggal }}</td>
        <td>{{ d.nis }}</td>
        <td>{{ d.nama }}</td>
        <td>{{ d.kelas }}</td>
        <td>{{ d.jenis_absen }}</td>
        <td>{{ d.status }}</td>
        <td>{{ d.jam }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Tombol Export -->
  <div class="text-end mt-3">
    <a href="{{ url_for('admin.export_absensi') }}" class="btn btn-success btn-sm">üì• Export Excel</a>
    <a href="{{ url_for('admin.export_pdf') }}" class="btn btn-danger btn-sm">üñ®Ô∏è Export PDF</a>
  </div>

  <!-- Tanda Tangan -->
  <div class="mt-5 row text-center">
    <div class="col">
      <p>Mengetahui,</p>
      <p><strong>Kepala Sekolah</strong></p><br><br>
      <p><u>{{ kepala_sekolah }}</u></p>
    </div>
    <div class="col">
      <p>Tangerang, {{ tgl_akhir }}</p>
      <p><strong>Staf Tata Usaha</strong></p><br><br>
      <p><u>{{ operator }}</u></p>
    </div>
  </div>
</div>

<!-- Grafik Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('grafik').getContext('2d');
new Chart(ctx, {
  type: 'bar',
  data: {
    labels: ['Hadir', 'Terlambat', 'Sakit', 'Izin', 'Bolos'],
    datasets: [{
      label: 'Statistik Absensi',
      data: [{{ total_hadir }}, {{ total_terlambat }}, {{ total_sakit }}, {{ total_izin }}, {{ total_bolos }}],
      borderWidth: 1
    }]
  },
  options: {
    scales: {
      y: { beginAtZero: true }
    }
  }
});
</script>
{% endblock %}
